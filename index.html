<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personnel Tracker System (Local IndexedDB)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --neon-purple: #6333b2;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #0f172a;
        color: #e2e8f0;
      }
      .container-card {
        background-color: #1e293b;
        border: 1px solid #334155;
      }

      .data-table-container {
        max-height: 50vh;
        overflow-y: auto;
      }

      .tree-row {
        cursor: pointer;
      }
      .tree-row:hover {
        background-color: #334155;
      }
      input,
      textarea {
        background-color: #334155;
        color: #f8fafc;
        border-color: #475569;
      }
      input:focus,
      textarea:focus {
        border-color: var(--neon-purple);
        box-shadow: 0 0 0 3px rgba(192, 132, 252, 0.5);
      }
      .data-table-container thead {
        background-color: #1e293b;
        border-bottom: 2px solid #6333b2;
      }

      input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        border: 1px solid #6333b2;
        width: 1rem;
        height: 1rem;
        cursor: pointer;
        display: inline-block;
        vertical-align: middle;
        position: relative;
        background-color: #1e293b;
        border-radius: 0.25rem;
      }
      input[type="checkbox"]:checked {
        background-color: #6333b2;
        border-color: #6333b2;
      }
      input[type="checkbox"]:checked:after {
        content: "‚úì";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #1e293b;
        font-size: 0.75rem;
        font-weight: bold;
      }

      #analytics-sidebar {
        transition: transform 0.3s ease-in-out;
        transform: translateX(100%);
        z-index: 100;
      }
      #analytics-sidebar.open {
        transform: translateX(0);
      }
      #sidebar-overlay {
        transition: opacity 0.3s ease-in-out;
        z-index: 90;
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <div
      id="sidebar-overlay"
      onclick="toggleSidebar(false)"
      class="fixed inset-0 bg-black bg-opacity-70 hidden"
    ></div>

    <aside
      id="analytics-sidebar"
      class="fixed top-0 right-0 h-full w-full max-w-xs container-card shadow-2xl p-6 overflow-y-auto"
    >
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-violet-600">System Analytics</h2>
        <button
          onclick="toggleSidebar(false)"
          class="text-white hover:text-violet-600 p-1 rounded-full bg-gray-700/50 transition"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <div class="space-y-4">
        <div
          class="bg-indigo-900/40 p-4 rounded-xl shadow-lg border border-indigo-700/50"
        >
          <p class="text-sm font-medium text-indigo-300">Total Contacts</p>
          <p
            id="stat-total-contacts"
            class="text-3xl font-extrabold text-white mt-1"
          >
            0
          </p>
        </div>

        <div
          class="bg-green-900/40 p-4 rounded-xl shadow-lg border border-green-700/50"
        >
          <p class="text-sm font-medium text-green-300">With Profile Image</p>
          <p
            id="stat-with-image"
            class="text-3xl font-extrabold text-white mt-1"
          >
            0
          </p>
        </div>

        <div
          class="bg-red-900/40 p-4 rounded-xl shadow-lg border border-red-700/50"
        >
          <p class="text-sm font-medium text-red-300">Needs Profile Image</p>
          <p
            id="stat-without-image"
            class="text-3xl font-extrabold text-white mt-1"
          >
            0
          </p>
        </div>
      </div>
    </aside>

    <div
      id="app"
      class="max-w-4xl mx-auto container-card shadow-2xl rounded-xl p-6 md:p-10"
    >
      <header
        class="flex justify-between items-center mb-6 border-b-2 border-violet-600 pb-2"
      >
        <h1 class="text-3xl font-extrabold text-white flex items-center">
          Contacts
        </h1>
        <button
          onclick="toggleSidebar(true)"
          class="p-2 rounded-lg bg-violet-600 hover:bg-violet-700 transition"
          aria-label="Open Analytics Menu"
        >
          <svg
            class="w-7 h-7 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            ></path>
          </svg>
        </button>
      </header>

      <div
        id="status-message"
        class="text-sm font-mono mb-4 p-3 rounded-lg bg-green-900/30 text-green-400"
      >
        ‚úÖ Database status: Initializing IndexedDB...
      </div>

      <div class="bg-gray-800 p-5 rounded-lg mb-8 border border-violet-500/20">
        <button
          id="toggle-add-btn"
          aria-expanded="false"
          aria-controls="add-contact-form-container"
          class="w-full text-left flex justify-between items-center pb-2 font-normal text-violet-600 text-xl hover:text-white transition"
        >
          ‚ûï Add New Contact
          <svg
            id="add-toggle-icon"
            class="w-6 h-6 transition-transform duration-300 transform rotate-180 text-violet-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            ></path>
          </svg>
        </button>

        <div
          id="add-contact-form-container"
          class="transition-all duration-300 overflow-hidden"
          style="max-height: 0"
        >
          <form
            id="add-form"
            class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4"
          >
            <input
              type="text"
              id="name"
              placeholder="Full Name *"
              required
              class="p-2 rounded-lg"
            />
            <input
              type="text"
              id="role"
              placeholder="Role/Job *"
              required
              class="p-2 rounded-lg"
            />
            <input
              type="tel"
              id="phone"
              placeholder="Phone #"
              class="p-2 rounded-lg"
            />
            <input
              type="email"
              id="email"
              placeholder="Email"
              class="p-2 rounded-lg"
            />

            <textarea
              id="address"
              placeholder="Full Address (optional)"
              rows="2"
              class="col-span-1 sm:col-span-2 p-2 rounded-lg"
            ></textarea>

            <div class="col-span-1 sm:col-span-2">
              <input
                type="file"
                id="image-file"
                accept="image/*"
                class="hidden"
              />
              <label
                for="image-file"
                id="image-label"
                class="block w-full p-2 bg-gray-700 border-2 border-dashed border-violet-600/50 text-violet-300 text-center rounded-lg cursor-pointer hover:bg-gray-900 transition"
              >
                Click to Select Profile Image (Optional)
              </label>
              <input type="hidden" id="image-data-url" />
            </div>

            <textarea
              id="notes"
              placeholder="Notes (optional)"
              rows="3"
              class="col-span-1 sm:col-span-2 p-2 rounded-lg"
            ></textarea>

            <button
              type="submit"
              id="add-btn"
              class="col-span-1 sm:col-span-2 py-3 bg-violet-600 text-white font-thin rounded-lg hover:bg-violet-700 transition"
            >
              ‚ûï Add Person to Contacts
            </button>
          </form>
        </div>
      </div>
      <input
        type="text"
        id="search-input"
        placeholder="üîç Search contacts by name..."
        class="w-full p-3 rounded-lg bg-gray-700 text-white mb-6 border border-gray-600 focus:ring-violet-500 focus:border-violet-500"
      />

      <div
        id="bulk-actions-bar"
        class="hidden flex flex-col sm:flex-row items-center justify-between p-3 mb-4 rounded-xl bg-gray-900 border border-violet-700/50 shadow-xl"
      >
        <span
          id="bulk-selection-count"
          class="font-semibold text-lg text-violet-600 mb-2 sm:mb-0"
        >
          0 contacts selected
        </span>
        <div class="flex gap-3">
          <button
            id="bulk-share-btn"
            class="px-4 py-2 bg-violet-600 text-white font-semibold rounded-lg hover:bg-violet-700 transition"
          >
            üì≤ Share Selected (Text)
          </button>
          <button
            id="bulk-export-btn"
            class="px-4 py-2 bg-violet-600 text-white font-semibold rounded-lg hover:bg-violet-700 transition"
          >
            üìÑ Export Selected (CSV)
          </button>
          <button
            id="bulk-delete-btn"
            class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition"
          >
            üóëÔ∏è Delete Selected
          </button>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-3 mb-6">
        <button
          id="export-all-csv-btn"
          class="w-full md:w-auto px-4 py-2 bg-violet-600 text-white font-thin rounded-lg hover:bg-violet-700 transition"
        >
          üìÑ Export All to CSV
        </button>
        <button
          id="backup-json-btn"
          class="w-full md:w-auto px-4 py-2 bg-violet-600 text-white font-thin rounded-lg hover:bg-violet-700 transition"
        >
          üì• Backup to JSON
        </button>
        <input
          type="file"
          id="restore-file-input"
          accept=".json"
          class="hidden"
        />
        <button
          id="restore-json-btn"
          class="w-full md:w-auto px-4 py-2 bg-violet-600 text-white font-thin rounded-lg hover:bg-violet-700 transition"
        >
          üì§ Restore from JSON
        </button>
      </div>

      <div class="mb-6 rounded-xl overflow-hidden border border-gray-700/50">
        <button
          id="toggle-list-btn"
          aria-expanded="false"
          aria-controls="contact-list-container"
          class="w-full text-left flex justify-between items-center px-4 py-3 bg-gray-700/50 hover:bg-gray-700 transition font-normal text-violet-600 text-lg"
        >
          Contacts Directory
          <svg
            id="toggle-icon"
            class="w-6 h-6 transition-transform duration-300 transform rotate-180 text-violet-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            ></path>
          </svg>
        </button>

        <div
          id="contact-list-container"
          class="data-table-container transition-all duration-300"
          style="max-height: 0"
        >
          <table class="min-w-full divide-y divide-gray-700">
            <thead>
              <tr>
                <th
                  class="p-3 text-center text-xs font-medium text-violet-600 uppercase tracking-wider"
                >
                  <input
                    type="checkbox"
                    id="select-all-checkbox"
                    title="Select All"
                  />
                </th>
                <th
                  onclick="handleSort('name')"
                  class="px-3 py-3 text-left text-xs font-medium text-violet-600 hover:text-white uppercase tracking-wider cursor-pointer hover:bg-gray-700/50 transition"
                >
                  Name & Contact Badges
                  <span id="sort-icon-name" class="ml-1 inline-block"></span>
                </th>
                <th
                  onclick="handleSort('role')"
                  class="px-3 py-3 text-left text-xs font-medium text-violet-600 hover:text-white uppercase tracking-wider hidden sm:table-cell cursor-pointer hover:bg-gray-700/50 transition"
                >
                  Role
                  <span id="sort-icon-role" class="ml-1 inline-block"></span>
                </th>
                <th
                  class="px-3 py-3 text-left text-xs font-medium text-violet-600 uppercase tracking-wider hidden md:table-cell"
                >
                  Contact Info
                </th>
                <th
                  class="px-3 py-3 text-left text-xs font-medium text-violet-600 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="people-list"
              class="divide-y divide-gray-700 bg-gray-800/50"
            >
              <tr>
                <td colspan="5" class="text-center py-4 text-gray-400">
                  Loading local data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div
      id="edit-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden items-center justify-center p-4 z-50"
    >
      <div class="container-card rounded-xl p-6 w-full max-w-md">
        <h3 class="text-2xl font-bold mb-4 text-violet-600">Contact Details</h3>
        <form id="edit-form" class="space-y-4">
          <input type="hidden" id="edit-id" />
          <input
            type="text"
            id="edit-name"
            placeholder="Full Name"
            required
            class="w-full p-2 rounded-lg"
          />
          <input
            type="text"
            id="edit-role"
            placeholder="Role/Job"
            required
            class="w-full p-2 rounded-lg"
          />
          <input
            type="tel"
            id="edit-phone"
            placeholder="Phone #"
            class="w-full p-2 rounded-lg"
          />
          <input
            type="email"
            id="edit-email"
            placeholder="Email"
            class="w-full p-2 rounded-lg"
          />

          <textarea
            id="edit-address"
            placeholder="Full Address (optional)"
            rows="2"
            class="w-full p-2 rounded-lg"
          ></textarea>

          <div
            class="text-center p-3 border border-gray-600 rounded-lg bg-gray-700"
          >
            <img
              id="edit-image-preview"
              class="w-24 h-24 rounded-full mx-auto mb-2 object-cover border-2 border-violet-600"
              src="https://placehold.co/96x96/dddddd/ffffff?text=No+Img"
              alt="Profile Image"
            />
            <input
              type="file"
              id="edit-image-file"
              accept="image/*"
              class="hidden"
            />
            <label
              for="edit-image-file"
              class="text-violet-600 cursor-pointer hover:text-violet-300"
              >Change Image</label
            >
            <input type="hidden" id="edit-image-data-url" />
          </div>

          <div
            id="modal-contact-actions"
            class="flex flex-wrap justify-center items-center gap-3 pt-2 pb-4 border-b border-gray-700"
          ></div>
          <textarea
            id="edit-notes"
            placeholder="Notes (optional)"
            rows="4"
            class="w-full p-2 rounded-lg"
          ></textarea>

          <div class="flex flex-col gap-3 pt-4 sm:flex-row sm:justify-end">
            <button
              type="button"
              id="delete-btn"
              onclick="deletePersonWrapper(this)"
              data-delete-state="0"
              class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
            >
              üóëÔ∏è Delete
            </button>
            <button
              type="submit"
              class="w-full sm:w-auto px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition"
            >
              üíæ Save Changes
            </button>
            <button
              type="button"
              onclick="closeModal()"
              class="w-full sm:w-auto px-4 py-2 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-700 transition"
            >
              Close
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const DB_NAME = "PersonnelTrackerDB";
      const STORE_NAME = "people";
      const DB_VERSION = 1;
      let db = null;
      let allPeople = [];

      let currentSort = { key: "name", direction: "asc" };
      const selectedPeople = new Set();

      const statusElement = document.getElementById("status-message");
      const editModal = document.getElementById("edit-modal");
      const searchInput = document.getElementById("search-input");

      const toggleButton = document.getElementById("toggle-list-btn");
      const contactListContainer = document.getElementById(
        "contact-list-container"
      );
      const toggleIcon = document.getElementById("toggle-icon");

      const toggleAddBtn = document.getElementById("toggle-add-btn");
      const addFormContainer = document.getElementById(
        "add-contact-form-container"
      );
      const addToggleIcon = document.getElementById("add-toggle-icon");

      const statTotalContacts = document.getElementById("stat-total-contacts");
      const statWithImage = document.getElementById("stat-with-image");
      const statWithoutImage = document.getElementById("stat-without-image");

      const bulkActionBar = document.getElementById("bulk-actions-bar");
      const bulkSelectionCount = document.getElementById(
        "bulk-selection-count"
      );
      const selectAllCheckbox = document.getElementById("select-all-checkbox");

      const analyticsSidebar = document.getElementById("analytics-sidebar");
      const sidebarOverlay = document.getElementById("sidebar-overlay");

      document.addEventListener("DOMContentLoaded", () => {
        loadData();

        document
          .getElementById("add-form")
          .addEventListener("submit", handleAddFormSubmit);
        document
          .getElementById("edit-form")
          .addEventListener("submit", handleEditFormSubmit);

        document
          .getElementById("image-file")
          .addEventListener("change", handleImageFileChange);
        document
          .getElementById("edit-image-file")
          .addEventListener("change", handleEditImageFileChange);

        searchInput.addEventListener("input", filterPeople);

        selectAllCheckbox.addEventListener("change", (e) =>
          toggleSelectAll(e.target.checked)
        );
        document
          .getElementById("bulk-share-btn")
          .addEventListener("click", bulkShareSelectedText);
        document
          .getElementById("bulk-delete-btn")
          .addEventListener("click", bulkDeleteSelected);
        document
          .getElementById("bulk-export-btn")
          .addEventListener("click", bulkExportSelected);

        document
          .getElementById("export-all-csv-btn")
          .addEventListener("click", exportAllCSV);
        document
          .getElementById("backup-json-btn")
          .addEventListener("click", backupJSON);
        document
          .getElementById("restore-json-btn")
          .addEventListener("click", () =>
            document.getElementById("restore-file-input").click()
          );
        document
          .getElementById("restore-file-input")
          .addEventListener("change", restoreJSON);

        toggleButton.addEventListener("click", toggleList);
        toggleAddBtn.addEventListener("click", toggleAddForm);

        editModal.addEventListener("click", (e) => {
          if (e.target === editModal) {
            closeModal();
          }
        });
      });

      window.toggleSidebar = function (open) {
        if (open) {
          analyticsSidebar.classList.add("open");
          sidebarOverlay.classList.remove("hidden");
        } else {
          analyticsSidebar.classList.remove("open");
          sidebarOverlay.classList.add("hidden");
        }
      };

      function toggleList() {
        const isExpanded =
          toggleButton.getAttribute("aria-expanded") === "true";

        if (isExpanded) {
          contactListContainer.style.maxHeight = "0";
          toggleIcon.classList.add("rotate-180");
          toggleButton.setAttribute("aria-expanded", "false");
        } else {
          contactListContainer.style.maxHeight = "50vh";
          toggleIcon.classList.remove("rotate-180");
          toggleButton.setAttribute("aria-expanded", "true");
        }
      }

      function toggleAddForm() {
        const isExpanded =
          toggleAddBtn.getAttribute("aria-expanded") === "true";

        if (isExpanded) {
          addFormContainer.style.maxHeight = "0";
          addToggleIcon.classList.add("rotate-180");
          toggleAddBtn.setAttribute("aria-expanded", "false");
        } else {
          addFormContainer.style.maxHeight =
            addFormContainer.scrollHeight + "px";
          addToggleIcon.classList.remove("rotate-180");
          toggleAddBtn.setAttribute("aria-expanded", "true");
        }
      }

      function updateStatus(message, isError = false) {
        statusElement.innerHTML = message;
        if (isError) {
          statusElement.classList.remove("bg-green-900/30", "text-green-400");
          statusElement.classList.add("bg-red-900/30", "text-red-400");
        } else {
          statusElement.classList.remove("bg-red-900/30", "text-red-400");
          statusElement.classList.add("bg-green-900/30", "text-green-400");
        }
      }

      function getDatabase() {
        return new Promise((resolve, reject) => {
          if (db) {
            resolve(db);
            return;
          }
          updateStatus("üü° Database status: Attempting to open IndexedDB...");

          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onupgradeneeded = (event) => {
            const dbInstance = event.target.result;
            if (!dbInstance.objectStoreNames.contains(STORE_NAME)) {
              dbInstance.createObjectStore(STORE_NAME, {
                keyPath: "id",
                autoIncrement: true,
              });
            }
          };

          request.onsuccess = (event) => {
            db = event.target.result;
            updateStatus("‚úÖ Database status: Connected and ready.");
            resolve(db);
          };

          request.onerror = (event) => {
            console.error("IndexedDB Connection Error:", event.target.error);
            updateStatus(
              `‚ùå Database status: Failed to connect. Error: ${event.target.error.name}`,
              true
            );
            reject(event.target.error);
          };
        });
      }

      async function transaction(mode) {
        const dbInstance = await getDatabase();
        return dbInstance
          .transaction([STORE_NAME], mode)
          .objectStore(STORE_NAME);
      }

      async function getAllPeople() {
        try {
          const store = await transaction("readonly");
          const request = store.getAll();

          return new Promise((resolve) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => {
              console.error("Error fetching people data:", e.target.error);
              resolve([]);
            };
          });
        } catch (e) {
          console.error("Database transaction unavailable:", e);
          return [];
        }
      }

      async function loadData() {
        const listElement = document.getElementById("people-list");
        listElement.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">Fetching data...</td></tr>`;

        try {
          allPeople = await getAllPeople();

          selectedPeople.clear();
          updateBulkActionControls();

          allPeople.sort((a, b) => {
            const aVal = (a[currentSort.key] || "").toLowerCase();
            const bVal = (b[currentSort.key] || "").toLowerCase();

            if (aVal < bVal) return currentSort.direction === "asc" ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === "asc" ? 1 : -1;
            return 0;
          });

          updateAnalytics(allPeople);

          filterPeople();
        } catch (e) {
          console.error("Failed to load all data during startup:", e);
          listElement.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-400">üö® Failed to load contacts from local storage.</td></tr>`;
        }
      }

      function updateAnalytics(people) {
        const total = people.length;
        const withImage = people.filter(
          (p) =>
            p.imageDataURL &&
            p.imageDataURL.length > 0 &&
            p.imageDataURL !==
              "https://placehold.co/96x96/dddddd/ffffff?text=No+Img"
        ).length;
        const withoutImage = total - withImage;

        statTotalContacts.textContent = total;
        statWithImage.textContent = withImage;
        statWithoutImage.textContent = withoutImage;
      }

      async function savePerson(personData) {
        try {
          const store = await transaction("readwrite");
          const request = store.add({ ...personData, id: Date.now() });
          request.onsuccess = () => loadData();
          request.onerror = (e) =>
            console.error("Save failed:", e.target.error);
        } catch (e) {
          console.error("Failed to execute save transaction.", e);
        }
      }

      async function updatePerson(id, personData) {
        try {
          const store = await transaction("readwrite");
          const request = store.put({ ...personData, id: id });
          request.onsuccess = () => loadData();
          request.onerror = (e) =>
            console.error("Update failed:", e.target.error);
        } catch (e) {
          console.error("Failed to execute update transaction.", e);
        }
      }

      async function deletePerson(id) {
        try {
          const store = await transaction("readwrite");
          const request = store.delete(id);
          request.onsuccess = () => loadData();
          request.onerror = (e) =>
            console.error("Delete failed:", e.target.error);
        } catch (e) {
          console.error("Failed to execute delete transaction.", e);
        }
      }

      const filterPeople = () => {
        const query = searchInput.value.toLowerCase().trim();

        if (query.length > 0) {
          const isExpanded =
            toggleButton.getAttribute("aria-expanded") === "true";
          if (!isExpanded) {
            toggleList();
          }
        }

        const filtered = allPeople.filter((person) => {
          return (
            (person.name || "").toLowerCase().includes(query) ||
            (person.role || "").toLowerCase().includes(query) ||
            (person.address || "").toLowerCase().includes(query)
          ); // Check address too
        });

        renderPeopleList(filtered);
      };

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(file);
        });
      }

      async function handleImageFileChange(e) {
        const file = e.target.files[0];
        const imageLabel = document.getElementById("image-label");
        const imageDataUrlInput = document.getElementById("image-data-url");

        if (file) {
          try {
            const dataUrl = await fileToBase64(file);
            imageDataUrlInput.value = dataUrl;
            imageLabel.textContent = `Image Selected: ${file.name}`;
            imageLabel.classList.remove("border-violet-600/50");
            imageLabel.classList.add("border-green-400/50");
          } catch (error) {
            console.error("Error converting file to base64:", error);
            imageDataUrlInput.value = "";
            imageLabel.textContent = "Error loading image (Click to try again)";
            imageLabel.classList.add("border-violet-600/50");
            imageLabel.classList.remove("border-green-400/50");
          }
        } else {
          imageDataUrlInput.value = "";
          imageLabel.textContent = "Click to Select Profile Image (Optional)";
          imageLabel.classList.add("border-violet-600/50");
          imageLabel.classList.remove("border-green-400/50");
        }
      }

      async function handleEditImageFileChange(e) {
        const file = e.target.files[0];
        const imageDataUrlInput = document.getElementById(
          "edit-image-data-url"
        );
        const imagePreview = document.getElementById("edit-image-preview");

        if (file) {
          try {
            const dataUrl = await fileToBase64(file);
            imageDataUrlInput.value = dataUrl;
            imagePreview.src = dataUrl;
          } catch (error) {
            console.error("Error converting file to base64:", error);
          }
        }
      }

      async function handleAddFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const personData = {
          name: document.getElementById("name").value.trim(),
          role: document.getElementById("role").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          email: document.getElementById("email").value.trim(),
          // NEW: Address field
          address: document.getElementById("address").value.trim(),
          notes: document.getElementById("notes").value.trim(),
          imageDataURL: document.getElementById("image-data-url").value.trim(),
        };

        await savePerson(personData);
        form.reset();
        document.getElementById("image-label").textContent =
          "Click to Select Profile Image (Optional)";
        document
          .getElementById("image-label")
          .classList.add("border-violet-600/50");
        document
          .getElementById("image-label")
          .classList.remove("border-green-400/50");

        if (toggleAddBtn.getAttribute("aria-expanded") === "true") {
          toggleAddForm();
        }
      }

      async function handleEditFormSubmit(e) {
        e.preventDefault();
        const personId = parseInt(document.getElementById("edit-id").value);
        const personData = {
          name: document.getElementById("edit-name").value.trim(),
          role: document.getElementById("edit-role").value.trim(),
          phone: document.getElementById("edit-phone").value.trim(),
          email: document.getElementById("edit-email").value.trim(),
          // NEW: Address field
          address: document.getElementById("edit-address").value.trim(),
          notes: document.getElementById("edit-notes").value.trim(),
          imageDataURL: document
            .getElementById("edit-image-data-url")
            .value.trim(),
        };

        await updatePerson(personId, personData);
        closeModal();
      }

      function updateBulkActionControls() {
        const count = selectedPeople.size;
        bulkSelectionCount.textContent = `${count} contact${
          count === 1 ? "" : "s"
        } selected`;

        if (count > 0) {
          bulkActionBar.classList.remove("hidden");
          bulkActionBar.classList.add("flex");
        } else {
          bulkActionBar.classList.add("hidden");
          bulkActionBar.classList.remove("flex");
        }

        const allVisibleIds = allPeople.map((p) => p.id);
        selectAllCheckbox.checked =
          count > 0 && allVisibleIds.every((id) => selectedPeople.has(id));
        selectAllCheckbox.indeterminate =
          count > 0 && count < allVisibleIds.length;
      }

      window.togglePersonSelection = function (id, isChecked) {
        if (isChecked) {
          selectedPeople.add(id);
        } else {
          selectedPeople.delete(id);
        }
        updateBulkActionControls();
      };

      window.toggleSelectAll = function (isChecked) {
        const query = searchInput.value.toLowerCase().trim();
        const visiblePeople = allPeople.filter((person) => {
          return (
            (person.name || "").toLowerCase().includes(query) ||
            (person.role || "").toLowerCase().includes(query) ||
            (person.address || "").toLowerCase().includes(query)
          );
        });

        if (isChecked) {
          visiblePeople.forEach((person) => selectedPeople.add(person.id));
        } else {
          visiblePeople.forEach((person) => selectedPeople.delete(person.id));
        }

        filterPeople();
        updateBulkActionControls();
      };

      async function bulkDeleteSelected() {
        if (selectedPeople.size === 0) return;

        if (
          !confirm(
            `Are you sure you want to delete ${selectedPeople.size} selected contact(s)? This action cannot be undone.`
          )
        ) {
          return;
        }

        updateStatus(`üü° Deleting ${selectedPeople.size} contacts...`, false);

        try {
          const store = await transaction("readwrite");
          selectedPeople.forEach((id) => {
            store.delete(id);
          });

          await new Promise((resolve, reject) => {
            store.transaction.oncomplete = resolve;
            store.transaction.onerror = reject;
          });

          await loadData();
          updateStatus(
            `‚úÖ Successfully deleted ${selectedPeople.size} contact(s).`,
            false
          );
          selectedPeople.clear();
          updateBulkActionControls();
        } catch (e) {
          console.error("Bulk delete failed:", e);
          updateStatus("‚ùå Bulk delete failed. See console for details.", true);
        }
      }

      function bulkShareSelectedText() {
        if (selectedPeople.size === 0)
          return updateStatus(
            "üü° Bulk Share skipped: No contacts selected.",
            false
          );

        const selectedData = allPeople.filter((p) => selectedPeople.has(p.id));

        let messageBody = "Contact(s) Shared from Personnel Tracker:\n\n";

        selectedData.forEach((person, index) => {
          messageBody += `${index + 1}. ${person.name} (${person.role})\n`;
          if (person.phone) {
            messageBody += `   Phone: ${person.phone}\n`;
          }
          if (person.email) {
            messageBody += `   Email: ${person.email}\n`;
          }
          if (person.address) {
            messageBody += `   Address: ${person.address.replace(
              /\r?\n|\r/g,
              " / "
            )}\n`;
          }
          messageBody += "\n";
        });

        const encodedBody = encodeURIComponent(messageBody.trim());
        const smsUri = `sms:?body=${encodedBody}`;

        window.location.href = smsUri;

        updateStatus(
          `‚úÖ Share successful! Prepared ${selectedData.length} contact(s) for text sharing.`,
          false
        );
      }

      function bulkExportSelected() {
        if (selectedPeople.size === 0)
          return updateStatus(
            "üü° Bulk Export skipped: No contacts selected.",
            false
          );

        const selectedData = allPeople.filter((p) => selectedPeople.has(p.id));

        // NEW: Added 'Address' column
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Name,Role,Phone,Email,Address,Notes\n";

        selectedData.forEach((person) => {
          const row = [
            person.name,
            person.role,
            person.phone || "",
            person.email || "",
            // NEW: Address data
            `"${(person.address || "")
              .replace(/"/g, '""')
              .replace(/\r?\n|\r/g, " ")}"`,
            `"${(person.notes || "")
              .replace(/"/g, '""')
              .replace(/\r?\n|\r/g, " ")}"`,
          ]
            .map((item) => (item.includes(",") ? `"${item}"` : item))
            .join(",");
          csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute(
          "download",
          `personnel_selected_data_${new Date().toISOString().slice(0, 10)}.csv`
        );
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        updateStatus(
          `‚úÖ Bulk CSV Export successful! Downloaded ${selectedData.length} selected records.`,
          false
        );
      }

      function exportAllCSV() {
        // NEW: Added 'Address' column
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Name,Role,Phone,Email,Address,Notes\n";

        allPeople.forEach((person) => {
          const row = [
            person.name,
            person.role,
            person.phone || "",
            person.email || "",
            // NEW: Address data
            `"${(person.address || "")
              .replace(/"/g, '""')
              .replace(/\r?\n|\r/g, " ")}"`,
            `"${(person.notes || "")
              .replace(/"/g, '""')
              .replace(/\r?\n|\r/g, " ")}"`,
          ]
            .map((item) => (item.includes(",") ? `"${item}"` : item))
            .join(",");
          csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute(
          "download",
          `personnel_full_data_backup_${new Date()
            .toISOString()
            .slice(0, 10)}.csv`
        );
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        updateStatus(
          `‚úÖ CSV Export successful! Downloaded ${allPeople.length} records.`,
          false
        );
      }

      function backupJSON() {
        const jsonString = JSON.stringify(allPeople, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = `personnel_full_backup_${new Date()
          .toISOString()
          .slice(0, 10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        updateStatus(
          `‚úÖ JSON Backup successful! Downloaded ${allPeople.length} records.`,
          false
        );
      }

      function restoreJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        updateStatus("üü° Starting data restoration from JSON...", false);

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data))
              throw new Error("JSON format invalid: Expected an array.");

            if (
              !confirm(
                `Are you sure you want to replace all current data with ${data.length} records from the JSON file? This cannot be undone.`
              )
            ) {
              updateStatus("üü° Data restoration cancelled by user.", false);
              return;
            }

            const store = await transaction("readwrite");
            const clearRequest = store.clear();
            await new Promise((resolve, reject) => {
              clearRequest.onsuccess = resolve;
              clearRequest.onerror = reject;
            });

            data.forEach((person) => {
              store.put(person);
            });

            await new Promise((resolve, reject) => {
              store.transaction.oncomplete = resolve;
              store.transaction.onerror = reject;
            });

            await loadData();
            updateStatus(
              `‚úÖ Successfully restored and replaced data with ${data.length} records.`,
              false
            );
          } catch (error) {
            console.error("Data restore failed:", error);
            updateStatus(
              `‚ùå Data restoration failed. Error: ${error.message}`,
              true
            );
          }
        };
        reader.readAsText(file);
      }

      window.handleSort = function (key) {
        if (currentSort.key === key) {
          currentSort.direction =
            currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          currentSort.key = key;
          currentSort.direction = "asc";
        }
        loadData();
      };

      function renderPeopleList(people) {
        const listElement = document.getElementById("people-list");
        listElement.innerHTML = "";

        document
          .querySelectorAll('[id^="sort-icon-"]')
          .forEach((el) => (el.textContent = ""));
        const icon = currentSort.direction === "asc" ? "‚ñ≤" : "‚ñº";
        const sortIconEl = document.getElementById(
          `sort-icon-${currentSort.key}`
        );
        if (sortIconEl) {
          sortIconEl.textContent = icon;
        }

        if (people.length === 0) {
          listElement.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">No contacts found.</td></tr>`;
          return;
        }

        people.forEach((person) => {
          const isSelected = selectedPeople.has(person.id);
          const hasImage =
            person.imageDataURL && person.imageDataURL.length > 0;
          const hasContact = person.phone || person.email;
          const hasAddress = person.address && person.address.trim().length > 0; // NEW: Check for address

          const row = document.createElement("tr");
          row.className = `tree-row transition duration-150 cursor-pointer ${
            isSelected ? "bg-violet-900/40" : ""
          }`;
          row.setAttribute("onclick", `openEditModal(${person.id})`);

          row.innerHTML = `
                    <td class="p-3 text-center" onclick="event.stopPropagation()"> 
                        <input type="checkbox" onchange="togglePersonSelection(${
                          person.id
                        }, this.checked)" ${
            isSelected ? "checked" : ""
          } title="Select">
                    </td>
                    <td class="px-3 py-3 font-semibold text-white">
                        <div class="flex items-center space-x-3">
                            <img class="w-10 h-10 rounded-full object-cover border-2 ${
                              hasImage ? "border-violet-600" : "border-gray-500"
                            }" 
                                 src="${
                                   person.imageDataURL ||
                                   "https://placehold.co/40x40/dddddd/ffffff?text=No+Img"
                                 }" 
                                 alt="${person.name} Profile">
                            <div>
                                <div class="text-lg">${person.name}</div>
                                <div class="text-xs text-gray-400 flex items-center gap-2 mt-1 sm:hidden">
                                    ${person.role}
                                </div>
                                <div class="text-xs text-gray-400 flex items-center gap-2 mt-1">
                                    ${
                                      hasContact
                                        ? `<span class="bg-violet-500/20 text-violet-300 px-2 py-0.5 rounded-full">Contact</span>`
                                        : ""
                                    }
                                    ${
                                      hasImage
                                        ? `<span class="bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded-full">Photo</span>`
                                        : ""
                                    }
                                    ${
                                      hasAddress
                                        ? `<span class="bg-yellow-500/20 text-yellow-300 px-2 py-0.5 rounded-full">Location</span>`
                                        : ""
                                    } </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-3 hidden sm:table-cell text-gray-300">${
                      person.role
                    }</td>
                    <td class="px-3 py-3 hidden md:table-cell text-sm text-gray-400">
                        ${
                          person.phone
                            ? `<div class="flex gap-2 mb-1">
                                <a href="tel:${person.phone}" class="text-violet-600 hover:text-violet-300 font-medium" onclick="event.stopPropagation()">üìû Call</a>
                                <span class="text-gray-600">|</span>
                                <a href="sms:${person.phone}" class="text-violet-600 hover:text-violet-300 font-medium" onclick="event.stopPropagation()">üí¨ Text</a>
                            </div>`
                            : ""
                        }
                        ${
                          person.email
                            ? `<div>
                                <a href="mailto:${person.email}" class="text-violet-600 hover:text-violet-300 truncate" onclick="event.stopPropagation()">${person.email}</a>
                            </div>`
                            : ""
                        }
                    </td>
                    <td class="px-3 py-3" onclick="event.stopPropagation()">
                        <button onclick="openEditModal(${
                          person.id
                        })" class="text-sm px-3 py-1 bg-yellow-600/50 text-yellow-300 rounded-lg hover:bg-yellow-600 hover:text-white transition">
                            ‚úèÔ∏è Edit
                        </button>
                    </td>
                `;
          listElement.appendChild(row);
        });
      }

      const closeModal = () => {
        editModal.classList.add("hidden");
        editModal.classList.remove("flex");
        const deleteBtn = document.getElementById("delete-btn");
        deleteBtn.textContent = "üóëÔ∏è Delete";
        deleteBtn.classList.add("bg-red-600", "hover:bg-red-700");
        deleteBtn.classList.remove("bg-orange-500", "hover:bg-orange-600");
        deleteBtn.dataset.deleteState = "0";
      };
      window.closeModal = closeModal;

      window.openEditModal = (id) => {
        const person = allPeople.find((p) => p.id === id);
        if (!person) return;

        document.getElementById("edit-id").value = id;
        document.getElementById("edit-name").value = person.name || "";
        document.getElementById("edit-role").value = person.role || "";
        document.getElementById("edit-phone").value = person.phone || "";
        document.getElementById("edit-email").value = person.email || "";
        document.getElementById("edit-address").value = person.address || ""; // NEW: Populate address
        document.getElementById("edit-notes").value = person.notes || "";

        const imageDataURL = person.imageDataURL || "";
        document.getElementById("edit-image-data-url").value = imageDataURL;
        document.getElementById("edit-image-preview").src =
          imageDataURL ||
          "https://placehold.co/96x96/dddddd/ffffff?text=No+Img";

        const contactActions = document.getElementById("modal-contact-actions");
        contactActions.innerHTML = "";

        if (person.phone) {
          contactActions.innerHTML += `
                    <a href="tel:${person.phone}" class="flex items-center gap-2 px-3 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition font-thin">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                        Call
                    </a>
                `;
          contactActions.innerHTML += `
                    <a href="sms:${person.phone}" class="flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-thin">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.673a9.965 9.965 0 01-1.631-4.327c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        Text
                    </a>
                `;
        }
        if (person.email) {
          contactActions.innerHTML += `
                    <a href="mailto:${person.email}" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-thin">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.8 5.2a2 2 0 002.4 0L21 8m-18 6V6a2 2 0 012-2h14a2 2 0 012 2v8m-18 0h18"></path></svg>
                        Email
                    </a>
                `;
        }

        // NEW: Add a map link if address is present
        if (person.address) {
          const encodedAddress = encodeURIComponent(person.address);
          contactActions.innerHTML += `
                    <a href="https://maps.google.com/?q=${encodedAddress}" target="_blank" class="flex items-center gap-2 px-3 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-thin">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Map
                    </a>
                `;
        }

        closeModal();
        editModal.classList.add("flex");
        editModal.classList.remove("hidden");
      };

      window.deletePersonWrapper = function (btn) {
        let state = parseInt(btn.dataset.deleteState);
        const personId = parseInt(document.getElementById("edit-id").value);

        if (state === 0) {
          btn.textContent = "Click to CONFIRM DELETE";
          btn.classList.remove("bg-red-600", "hover:bg-red-700");
          btn.classList.add("bg-orange-500", "hover:bg-orange-600");
          btn.dataset.deleteState = "1";
        } else if (state === 1) {
          deletePerson(personId);
          closeModal();
        }
      };
    </script>
  </body>
</html>
